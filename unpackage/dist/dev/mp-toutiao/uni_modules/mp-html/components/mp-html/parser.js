"use strict";const A=require("../../../../common/vendor.js"),w={trustTags:C("a,abbr,ad,audio,b,blockquote,br,code,col,colgroup,dd,del,dl,dt,div,em,fieldset,h1,h2,h3,h4,h5,h6,hr,i,img,ins,label,legend,li,ol,p,q,ruby,rt,source,span,strong,sub,sup,table,tbody,td,tfoot,th,thead,tr,title,ul,video"),blockTags:C("address,article,aside,body,caption,center,cite,footer,header,html,nav,pre,section"),ignoreTags:C("area,base,canvas,embed,frame,head,iframe,input,link,map,meta,param,rp,script,source,style,textarea,title,track,wbr"),voidTags:C("area,base,br,col,circle,ellipse,embed,frame,hr,img,input,line,link,meta,param,path,polygon,rect,source,track,use,wbr"),entities:{lt:"<",gt:">",quot:'"',apos:"'",ensp:" ",emsp:" ",nbsp:" ",semi:";",ndash:"–",mdash:"—",middot:"·",lsquo:"‘",rsquo:"’",ldquo:"“",rdquo:"”",bull:"•",hellip:"…",larr:"←",uarr:"↑",rarr:"→",darr:"↓"},tagStyle:{address:"font-style:italic",big:"display:inline;font-size:1.2em",caption:"display:table-caption;text-align:center",center:"text-align:center",cite:"font-style:italic",dd:"margin-left:40px",mark:"background-color:yellow",pre:"font-family:monospace;white-space:pre",s:"text-decoration:line-through",small:"display:inline;font-size:0.8em",strike:"text-decoration:line-through",u:"text-decoration:underline"},svgDict:{animatetransform:"animateTransform",lineargradient:"linearGradient",viewbox:"viewBox",attributename:"attributeName",repeatcount:"repeatCount",repeatdur:"repeatDur",foreignobject:"foreignObject"}},S={},{windowWidth:L}=A.index.getSystemInfoSync(),T=C(` ,\r,
,	,\f`);let q=0;function C(t){const i=Object.create(null),e=t.split(",");for(let o=e.length;o--;)i[e[o]]=!0;return i}function I(t,i){let e=t.indexOf("&");for(;e!==-1;){const o=t.indexOf(";",e+3);let d;if(o===-1)break;t[e+1]==="#"?(d=parseInt((t[e+2]==="x"?"0":"")+t.substring(e+2,o)),isNaN(d)||(t=t.substr(0,e)+String.fromCharCode(d)+t.substr(o+1))):(d=t.substring(e+1,o),(w.entities[d]||d==="amp"&&i)&&(t=t.substr(0,e)+(w.entities[d]||"&")+t.substr(o+1))),e=t.indexOf("&",e+1)}return t}function z(t){let i=t.length-1;for(let e=i;e>=-1;e--)(e===-1||t[e].c||!t[e].name||t[e].name!=="div"&&t[e].name!=="p"&&t[e].name[0]!=="h"||(t[e].attrs.style||"").includes("inline"))&&(i-e>=5&&t.splice(e+1,i-e,{name:"div",attrs:{},children:t.slice(e+1,i+1)}),i=e-1)}function k(t){this.options=t||{},this.tagStyle=Object.assign({},w.tagStyle,this.options.tagStyle),this.imgList=t.imgList||[],this.imgList._unloadimgs=0,this.plugins=t.plugins||[],this.attrs=Object.create(null),this.stack=[],this.nodes=[],this.pre=(this.options.containerStyle||"").includes("white-space")&&this.options.containerStyle.includes("pre")?2:0}k.prototype.parse=function(t){for(let i=this.plugins.length;i--;)this.plugins[i].onUpdate&&(t=this.plugins[i].onUpdate(t,w)||t);for(new O(this).parse(t);this.stack.length;)this.popNode();return this.nodes.length>50&&z(this.nodes),this.nodes};k.prototype.expose=function(){for(let t=this.stack.length;t--;){const i=this.stack[t];if(i.c||i.name==="a"||i.name==="video"||i.name==="audio")return;i.c=1}};k.prototype.hook=function(t){for(let i=this.plugins.length;i--;)if(this.plugins[i].onParse&&this.plugins[i].onParse(t,this)===!1)return!1;return!0};k.prototype.getUrl=function(t){const i=this.options.domain;return t[0]==="/"?t[1]==="/"?t=(i?i.split("://")[0]:"http")+":"+t:i&&(t=i+t):!t.includes("data:")&&!t.includes("://")&&i&&(t=i+"/"+t),t};k.prototype.parseStyle=function(t){const i=t.attrs,e=(this.tagStyle[t.name]||"").split(";").concat((i.style||"").split(";")),o={};let d="";i.id&&!this.xml&&(this.options.useAnchor?this.expose():t.name!=="img"&&t.name!=="a"&&t.name!=="video"&&t.name!=="audio"&&(i.id=void 0)),i.width&&(o.width=parseFloat(i.width)+(i.width.includes("%")?"%":"px"),i.width=void 0),i.height&&(o.height=parseFloat(i.height)+(i.height.includes("%")?"%":"px"),i.height=void 0);for(let r=0,a=e.length;r<a;r++){const s=e[r].split(":");if(s.length<2)continue;const n=s.shift().trim().toLowerCase();let l=s.join(":").trim();if(l[0]==="-"&&l.lastIndexOf("-")>0||l.includes("safe"))d+=`;${n}:${l}`;else if(!o[n]||l.includes("import")||!o[n].includes("import")){if(l.includes("url")){let h=l.indexOf("(")+1;if(h){for(;l[h]==='"'||l[h]==="'"||T[l[h]];)h++;l=l.substr(0,h)+this.getUrl(l.substr(h))}}else l.includes("rpx")&&(l=l.replace(/[0-9.]+\s*rpx/g,h=>parseFloat(h)*L/750+"px"));o[n]=l}}return t.attrs.style=d,o};k.prototype.onTagName=function(t){this.tagName=this.xml?t:t.toLowerCase(),this.tagName==="svg"&&(this.xml=(this.xml||0)+1,w.ignoreTags.style=void 0)};k.prototype.onAttrName=function(t){t=this.xml?t:t.toLowerCase(),t.substr(0,5)==="data-"?t==="data-src"&&!this.attrs.src?this.attrName="src":this.tagName==="img"||this.tagName==="a"?this.attrName=t:this.attrName=void 0:(this.attrName=t,this.attrs[t]="T")};k.prototype.onAttrVal=function(t){const i=this.attrName||"";i==="style"||i==="href"?this.attrs[i]=I(t,!0):i.includes("src")?this.attrs[i]=this.getUrl(I(t,!0)):i&&(this.attrs[i]=t)};k.prototype.onOpenTag=function(t){const i=Object.create(null);i.name=this.tagName,i.attrs=this.attrs,this.options.nodes.length&&(i.type="node"),this.attrs=Object.create(null);const e=i.attrs,o=this.stack[this.stack.length-1],d=o?o.children:this.nodes,r=this.xml?t:w.voidTags[i.name];if(S[i.name]&&(e.class=S[i.name]+(e.class?" "+e.class:"")),i.name==="embed"){const a=e.src||"";a.includes(".mp4")||a.includes(".3gp")||a.includes(".m3u8")||(e.type||"").includes("video")?i.name="video":(a.includes(".mp3")||a.includes(".wav")||a.includes(".aac")||a.includes(".m4a")||(e.type||"").includes("audio"))&&(i.name="audio"),e.autostart&&(e.autoplay="T"),e.controls="T"}if((i.name==="video"||i.name==="audio")&&(i.name==="video"&&!e.id&&(e.id="v"+q++),!e.controls&&!e.autoplay&&(e.controls="T"),i.src=[],e.src&&(i.src.push(e.src),e.src=void 0),this.expose()),r){if(!this.hook(i)||w.ignoreTags[i.name]){i.name==="base"&&!this.options.domain?this.options.domain=e.href:i.name==="source"&&o&&(o.name==="video"||o.name==="audio")&&e.src&&o.src.push(e.src);return}const a=this.parseStyle(i);if(i.name==="img"){if(e.src&&(e.src.includes("webp")&&(i.webp="T"),e.src.includes("data:")&&!e["original-src"]&&(e.ignore="T"),!e.ignore||i.webp||e.src.includes("cloud://"))){for(let n=this.stack.length;n--;){const l=this.stack[n];l.name==="a"&&(i.a=l.attrs),l.name==="table"&&!i.webp&&!e.src.includes("cloud://")&&(!a.display||a.display.includes("inline")?i.t="inline-block":i.t=a.display,a.display=void 0);const h=l.attrs.style||"";if(h.includes("flex:")&&!h.includes("flex:0")&&!h.includes("flex: 0")&&(!a.width||parseInt(a.width)>100)){a.width="100% !important",a.height="";for(let y=n+1;y<this.stack.length;y++)this.stack[y].attrs.style=(this.stack[y].attrs.style||"").replace("inline-","")}else if(h.includes("flex")&&a.width==="100%")for(let y=n+1;y<this.stack.length;y++){const f=this.stack[y].attrs.style||"";if(!f.includes(";width")&&!f.includes(" width")&&f.indexOf("width")!==0){a.width="";break}}else h.includes("inline-block")&&(a.width&&a.width[a.width.length-1]==="%"?(l.attrs.style+=";max-width:"+a.width,a.width=""):l.attrs.style+=";max-width:100%");l.c=1}e.i=this.imgList.length.toString();let s=e["original-src"]||e.src;if(this.imgList.includes(s)){let n=s.indexOf("://");if(n!==-1){n+=3;let l=s.substr(0,n);for(;n<s.length&&s[n]!=="/";n++)l+=Math.random()>.5?s[n].toUpperCase():s[n];l+=s.substr(n),s=l}}this.imgList.push(s),i.t||(this.imgList._unloadimgs+=1)}a.display==="inline"&&(a.display=""),e.ignore&&(a["max-width"]=a["max-width"]||"100%",e.style+=";-webkit-touch-callout:none"),parseInt(a.width)>L&&(a.height=void 0),isNaN(parseInt(a.width))||(i.w="T"),!isNaN(parseInt(a.height))&&(!a.height.includes("%")||o&&(o.attrs.style||"").includes("height"))&&(i.h="T"),i.w&&i.h&&a["object-fit"]&&(a["object-fit"]==="contain"?i.m="aspectFit":a["object-fit"]==="cover"&&(i.m="aspectFill"))}else if(i.name==="svg"){d.push(i),this.stack.push(i),this.popNode();return}for(const s in a)a[s]&&(e.style+=`;${s}:${a[s].replace(" !important","")}`);e.style=e.style.substr(1)||void 0}else(i.name==="pre"||(e.style||"").includes("white-space")&&e.style.includes("pre"))&&this.pre!==2&&(this.pre=i.pre=1),i.children=[],this.stack.push(i);d.push(i)};k.prototype.onCloseTag=function(t){t=this.xml?t:t.toLowerCase();let i;for(i=this.stack.length;i--&&this.stack[i].name!==t;);if(i!==-1)for(;this.stack.length>i;)this.popNode();else(t==="p"||t==="br")&&(this.stack.length?this.stack[this.stack.length-1].children:this.nodes).push({name:t,attrs:{class:S[t]||"",style:this.tagStyle[t]||""}})};k.prototype.popNode=function(){const t=this.stack.pop();let i=t.attrs;const e=t.children,o=this.stack[this.stack.length-1],d=o?o.children:this.nodes;if(!this.hook(t)||w.ignoreTags[t.name]){t.name==="title"&&e.length&&e[0].type==="text"&&this.options.setTitle&&A.index.setNavigationBarTitle({title:e[0].text}),d.pop();return}if(t.pre&&this.pre!==2){this.pre=t.pre=void 0;for(let s=this.stack.length;s--;)this.stack[s].pre&&(this.pre=1)}const r={};if(t.name==="svg"){if(this.xml>1){this.xml--;return}let s="";const n=i.style;i.style="",i.xmlns="http://www.w3.org/2000/svg",function l(h){if(h.type==="text"){s+=h.text;return}const y=w.svgDict[h.name]||h.name;if(y==="foreignObject"){for(const f of h.children||[])if(f.attrs&&!f.attrs.xmlns){f.attrs.xmlns="http://www.w3.org/1999/xhtml";break}}s+="<"+y;for(const f in h.attrs){const v=h.attrs[f];v&&(s+=` ${w.svgDict[f]||f}="${v}"`)}if(!h.children)s+="/>";else{s+=">";for(let f=0;f<h.children.length;f++)l(h.children[f]);s+="</"+y+">"}}(t),t.name="img",t.attrs={src:"data:image/svg+xml;utf8,"+s.replace(/#/g,"%23"),style:n,ignore:"T"},t.children=void 0,this.xml=!1,w.ignoreTags.style=!0;return}if(i.align&&(t.name==="table"?i.align==="center"?r["margin-inline-start"]=r["margin-inline-end"]="auto":r.float=i.align:r["text-align"]=i.align,i.align=void 0),i.dir&&(r.direction=i.dir,i.dir=void 0),t.name==="font"&&(i.color&&(r.color=i.color,i.color=void 0),i.face&&(r["font-family"]=i.face,i.face=void 0),i.size)){let s=parseInt(i.size);isNaN(s)||(s<1?s=1:s>7&&(s=7),r["font-size"]=["x-small","small","medium","large","x-large","xx-large","xxx-large"][s-1]),i.size=void 0}if((i.class||"").includes("align-center")&&(r["text-align"]="center"),Object.assign(r,this.parseStyle(t)),t.name!=="table"&&parseInt(r.width)>L&&(r["max-width"]="100%",r["box-sizing"]="border-box"),w.blockTags[t.name]?t.name="div":!w.trustTags[t.name]&&!this.xml&&(t.name="span"),t.name==="a"||t.name==="ad")this.expose();else if(t.name==="video")(r.height||"").includes("auto")&&(r.height=void 0);else if((t.name==="ul"||t.name==="ol")&&t.c){const s={a:"lower-alpha",A:"upper-alpha",i:"lower-roman",I:"upper-roman"};s[i.type]&&(i.style+=";list-style-type:"+s[i.type],i.type=void 0);for(let n=e.length;n--;)e[n].name==="li"&&(e[n].c=1)}else if(t.name==="table"){let s=parseFloat(i.cellpadding),n=parseFloat(i.cellspacing);const l=parseFloat(i.border),h=r["border-color"],y=r["border-style"];if(t.c&&(isNaN(s)&&(s=2),isNaN(n)&&(n=2)),l&&(i.style+=`;border:${l}px ${y||"solid"} ${h||"gray"}`),t.flag&&t.c){r.display="grid",r["border-collapse"]==="collapse"&&(r["border-collapse"]=void 0,n=0),n?(r["grid-gap"]=n+"px",r.padding=n+"px"):l&&(i.style+=";border-left:0;border-top:0");const f=[],v=[],j=[],N={};(function x(g){for(let b=0;b<g.length;b++)if(g[b].name==="tr")v.push(g[b]);else if(g[b].name==="colgroup"){let p=1;for(const c of g[b].children||[])if(c.name==="col"){const m=c.attrs.style||"",u=m.indexOf("width")?m.indexOf(";width"):0;if(u!==-1){let $=m.indexOf(";",u+6);$===-1&&($=m.length),f[p]=m.substring(u?u+7:6,$)}p+=1}}else x(g[b].children||[])})(e);for(let x=1;x<=v.length;x++){let g=1;for(let b=0;b<v[x-1].children.length;b++){const p=v[x-1].children[b];if(p.name==="td"||p.name==="th"){for(;N[x+"."+g];)g++;let c=p.attrs.style||"",m=c.indexOf("width")?c.indexOf(";width"):0;if(m!==-1){let u=c.indexOf(";",m+6);u===-1&&(u=c.length),p.attrs.colspan||(f[g]=c.substring(m?m+7:6,u)),c=c.substr(0,m)+c.substr(u)}if(c+=";display:flex",m=c.indexOf("vertical-align"),m!==-1){const u=c.substr(m+15,10);u.includes("middle")?c+=";align-items:center":u.includes("bottom")&&(c+=";align-items:flex-end")}else c+=";align-items:center";if(m=c.indexOf("text-align"),m!==-1){const u=c.substr(m+11,10);u.includes("center")?c+=";justify-content: center":u.includes("right")&&(c+=";justify-content: right")}if(c=(l?`;border:${l}px ${y||"solid"} ${h||"gray"}`+(n?"":";border-right:0;border-bottom:0"):"")+(s?`;padding:${s}px`:"")+";"+c,p.attrs.colspan&&(c+=`;grid-column-start:${g};grid-column-end:${g+parseInt(p.attrs.colspan)}`,p.attrs.rowspan||(c+=`;grid-row-start:${x};grid-row-end:${x+1}`),g+=parseInt(p.attrs.colspan)-1),p.attrs.rowspan){c+=`;grid-row-start:${x};grid-row-end:${x+parseInt(p.attrs.rowspan)}`,p.attrs.colspan||(c+=`;grid-column-start:${g};grid-column-end:${g+1}`);for(let u=1;u<p.attrs.rowspan;u++)for(let $=0;$<(p.attrs.colspan||1);$++)N[x+u+"."+(g-$)]=1}c&&(p.attrs.style=c),j.push(p),g++}}if(x===1){let b="";for(let p=1;p<g;p++)b+=(f[p]?f[p]:"auto")+" ";r["grid-template-columns"]=b}}t.children=j}else t.c&&(r.display="table"),isNaN(n)||(r["border-spacing"]=n+"px"),(l||s)&&function f(v){for(let j=0;j<v.length;j++){const N=v[j];N.name==="th"||N.name==="td"?(l&&(N.attrs.style=`border:${l}px ${y||"solid"} ${h||"gray"};${N.attrs.style||""}`),s&&(N.attrs.style=`padding:${s}px;${N.attrs.style||""}`)):N.children&&f(N.children)}}(e);if(this.options.scrollTable&&!(i.style||"").includes("inline")){const f=Object.assign({},t);t.name="div",t.attrs={style:"overflow:auto"},t.children=[f],i=f.attrs}}else if((t.name==="td"||t.name==="th")&&(i.colspan||i.rowspan)){for(let s=this.stack.length;s--;)if(this.stack[s].name==="table"){this.stack[s].flag=1;break}}else if(t.name==="ruby"){t.name="span";for(let s=0;s<e.length-1;s++)e[s].type==="text"&&e[s+1].name==="rt"&&(e[s]={name:"div",attrs:{style:"display:inline-block;text-align:center"},children:[{name:"div",attrs:{style:"font-size:50%;"+(e[s+1].attrs.style||"")},children:e[s+1].children},e[s]]},e.splice(s+1,1))}else t.c&&function(n){n.c=2;for(let l=n.children.length;l--;){const h=n.children[l];(!h.c||h.name==="table")&&(n.c=1)}}(t);if((r.display||"").includes("flex")&&!t.c)for(let s=e.length;s--;){const n=e[s];n.f&&(n.attrs.style=(n.attrs.style||"")+n.f,n.f=void 0)}const a=o&&((o.attrs.style||"").includes("flex")||(o.attrs.style||"").includes("grid"));a&&(t.f=";max-width:100%"),e.length>=50&&t.c&&!(r.display||"").includes("flex")&&z(e);for(const s in r)if(r[s]){const n=`;${s}:${r[s].replace(" !important","")}`;a&&(s.includes("flex")&&s!=="flex-direction"||s==="align-self"||s.includes("grid")||r[s][0]==="-"||s.includes("width")&&n.includes("%"))?(t.f+=n,s==="width"&&(i.style+=";width:100%")):i.style+=n}i.style=i.style.substr(1)||void 0};k.prototype.onText=function(t){if(!this.pre){let e="",o;for(let d=0,r=t.length;d<r;d++)T[t[d]]?(e[e.length-1]!==" "&&(e+=" "),t[d]===`
`&&!o&&(o=!0)):e+=t[d];if(e===" "){if(o)return;{const d=this.stack[this.stack.length-1];if(d&&d.name[0]==="t")return}}t=e}const i=Object.create(null);i.type="text",i.attrs={},i.text=I(t),this.hook(i)&&(this.stack.length?this.stack[this.stack.length-1].children:this.nodes).push(i)};function O(t){this.handler=t}O.prototype.parse=function(t){this.content=t||"",this.i=0,this.start=0,this.state=this.text;for(let i=this.content.length;this.i!==-1&&this.i<i;)this.state()};O.prototype.checkClose=function(t){const i=this.content[this.i]==="/";return this.content[this.i]===">"||i&&this.content[this.i+1]===">"?(t&&this.handler[t](this.content.substring(this.start,this.i)),this.i+=i?2:1,this.start=this.i,this.handler.onOpenTag(i),this.handler.tagName==="script"?(this.i=this.content.indexOf("</",this.i),this.i!==-1&&(this.i+=2,this.start=this.i),this.state=this.endTag):this.state=this.text,!0):!1};O.prototype.text=function(){if(this.i=this.content.indexOf("<",this.i),this.i===-1){this.start<this.content.length&&this.handler.onText(this.content.substring(this.start,this.content.length));return}const t=this.content[this.i+1];if(t>="a"&&t<="z"||t>="A"&&t<="Z")this.start!==this.i&&this.handler.onText(this.content.substring(this.start,this.i)),this.start=++this.i,this.state=this.tagName;else if(t==="/"||t==="!"||t==="?"){this.start!==this.i&&this.handler.onText(this.content.substring(this.start,this.i));const i=this.content[this.i+2];if(t==="/"&&(i>="a"&&i<="z"||i>="A"&&i<="Z")){this.i+=2,this.start=this.i,this.state=this.endTag;return}let e="-->";(t!=="!"||this.content[this.i+2]!=="-"||this.content[this.i+3]!=="-")&&(e=">"),this.i=this.content.indexOf(e,this.i),this.i!==-1&&(this.i+=e.length,this.start=this.i)}else this.i++};O.prototype.tagName=function(){if(T[this.content[this.i]]){for(this.handler.onTagName(this.content.substring(this.start,this.i));T[this.content[++this.i]];);this.i<this.content.length&&!this.checkClose()&&(this.start=this.i,this.state=this.attrName)}else this.checkClose("onTagName")||this.i++};O.prototype.attrName=function(){let t=this.content[this.i];if(T[t]||t==="="){this.handler.onAttrName(this.content.substring(this.start,this.i));let i=t==="=";const e=this.content.length;for(;++this.i<e;)if(t=this.content[this.i],!T[t]){if(this.checkClose())return;if(i){this.start=this.i,this.state=this.attrVal;return}if(this.content[this.i]==="=")i=!0;else{this.start=this.i,this.state=this.attrName;return}}}else this.checkClose("onAttrName")||this.i++};O.prototype.attrVal=function(){const t=this.content[this.i],i=this.content.length;if(t==='"'||t==="'"){if(this.start=++this.i,this.i=this.content.indexOf(t,this.i),this.i===-1)return;this.handler.onAttrVal(this.content.substring(this.start,this.i))}else for(;this.i<i;this.i++)if(T[this.content[this.i]]){this.handler.onAttrVal(this.content.substring(this.start,this.i));break}else if(this.checkClose("onAttrVal"))return;for(;T[this.content[++this.i]];);this.i<i&&!this.checkClose()&&(this.start=this.i,this.state=this.attrName)};O.prototype.endTag=function(){const t=this.content[this.i];if(T[t]||t===">"||t==="/"){if(this.handler.onCloseTag(this.content.substring(this.start,this.i)),t!==">"&&(this.i=this.content.indexOf(">",this.i),this.i===-1))return;this.start=++this.i,this.state=this.text}else this.i++};exports.Parser=k;
